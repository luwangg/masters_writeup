\chapter{Field Trials}
\label{ch:field-trials}
\setsvg{svgpath=./img/field-trials/}
\graphicspath{{./img/field-trials/}}

\section{Power supply}
It was necessary to power the ROACH from a battery in order to allow it to be portable and taken out into the open field.
Initially the plan was to power it from an inverter running off of a battery. Here, discuss why the inverter may be too noisy. Can this be shown from reverb chamber measurements?

Instead, an ATX power supply which runs directly from a \SI{12}{\volt} battery was made available from the SKA equipment. The power supply is made by Mini-Box and its part number is PicoPSU-80-WI-32V. This can output \SI{80}{\watt} which is enough to run the ROACH. To connect it, the traditional mains-powered ATX powersupply is disconnected from the motherboard and this module is plugged into the motherboard. This is shown in (insert figure here!).

Furthermore, a ROYAL 1150K battery was supplied. This is a \SI{105}{\ampere\hour} deep cycle calcium battery.
As the ROACH draws X amps at \SI{12}{\volt}, this implies that we are discharging the battery at \(\frac{105}{X} = \frac{C}{Y}\).
It is advised to not run down below \SI{70}{\percent} to maintain the battery lifespan. As shown by (cite battery charging), this implies that the voltage should not drop to below \SI{12.1}{\volt} when discharging at \(\frac{C}{Y}\).
Battery was charged at \(0.1 C = 0.1 \times 100 Ah = 10 A\) constant current until it got to \SI{13.8}{\volt} at which point it was charged constant voltage.

Testing in the lab showed that the ROACH pulled \SI{3.1}{\ampere} at \SI{12}{\volt} which is \SI{37}{\watt}. This can easily be handled by the \SI{80}{\watt} ATX power supply. 
Testing by running the ROACH from the battery overnight. The battery started at \SI{12.6}{\volt} and had dropped to \SI{11.9}{\volt} \SI{15}{\hour} later. The purpose of this test was not to provide a comprehensive report of the capacity of the battery or the requirements of the ROACH, but simply to show that the system will easily be able to run for a few hours in the field during field trials.

\section{Signal Source}
At its lowest power level, L1, Jason's Yaesu VX-7R HAM radio outputs \SI{17}{\dBm}.
Move Friss calculations to here.


\section{Narrow Band Transmitter}
A Raspberry Pi was used. An application called fm\_transmitter allows the Pi to broadcast an FM radio station by driving one of its GPIO pins. However the carrier can be well above the usual FM band. The carrier can be up to \SI{250}{\mega\hertz}. This is exactly the tone frequency we want. The application was set to continuously transmit a silent sound file on the bootup of the Pi to produce a continuous tone. NO! Tone actually 241.34. Why? Close to 250 but avoid internal 250 noise from FPGA clocks.

Just driving a pin is not enough. A quarter wavelength wire \SI{0.3}{\metre} long was connected to the pin as one half of a dipole and the shielding of the USB power cable used as the other half. This should produce a fairly well defined antenna with a well defined vertical polarisation.

With the GPIO pin toggling at such a high frequency, only about \SI{100}{\milli\volt} peak-to-peak voltage was present. This into the approximately \SI{75}{\ohm} of the half wave dipole means a EIRP of XX.

Free space path loss equation will be calculated to get an approximation of the power going into the LNAs and the power going into the ADCs. At \SI{2500}{\mega\hertz}, \(\lambda = \SI{1.2}{\meter}\). The maximum gain of the FD-250 folded dipole is approximately \SI{0}{\dBi}.

TODO: fix the following.
\begin{align}
  P_r &= P_t G_t G_r \left( \frac{\lambda}{4 \pi R} \right)^2 \\
      &= \SI{5}{\watt} \times 1 \times 1 \left( \frac{\SI{1.2}{\meter}}{4 \pi \times \SI{60}{\meter}} \right)^2 \\
      &= \SI{0.0000127}{\watt} \\
      &= \SI{0.0127}{\milli\watt} \\
     &= \SI{-19}{\dBm}
\end{align}

After the \SI{20}{\decibel} gain of the ZFL-500HLN LNAs, the power into the iADCs is approximately \SI{1}{\dBm}. Seeing as the ADC's full scale range is \SI{0}{\dBm}, a \SI{10}{\decibel} attenuation will be inserted after each LNA to bring the input signal down to a safe level.

\section{Ground Reflections}

The following simulation:
One Tx.
Two receives: RxA and RxB
RxB \SI{1}{\meter} futher away. 
Transmitter: \(s(t)\)
Direct:
\begin{equation}
  r(t) = f_a(\theta_a)f_b(\theta_b)(s(t)\frac{\lambda}{4\pi R} \exp\left\{ -j 2 \pi \frac{R}{\lambda}\right\}
\end{equation}
Where \(f_a(\theta_a)\) and \(f_b(\theta_b)\) are the beam patterns of antenna \(a\) and \(b\) respectively. For folded dipoles, we will assume them to be cosine beams. For this reason it makes sense to keep the Tx and Rx antennas at the same elevation as it will allow the direct beam to be in the peak of the main lobe
Both attenuation and phase shift are a function of \(R\).
TODO: carry on the beam pattern to the rest of the calulations. Useful thing: the grazing angle is the same theta as the beam offset angle!

This is simulated as the ideal, free space path.
Then ground reflection is added. It's another path \(R^\prime\)
This is similar but as well as being a longer path it has a ground reflection coefficient. 
This is what's simulated with \(\rho e^{j \phi}\)

As per Collin, Antenna and Radio Wave Propagation.
\begin{equation}
  \rho e^{j\phi} = \frac
    {(\kappa - j\chi)\sin\theta - \sqrt{(\kappa -j\chi) - \cos^2\theta}}
    {(\kappa - j\chi)\sin\theta + \sqrt{(\kappa -j\chi) - \cos^2\theta}}
\end{equation}
Where:
\begin{itemize}
  \item \(\chi = \alpha/\omega\epsilon_0\) with \(\alpha\) the solid conductivity and \(\omega\) being angular frequency
  \item \(\kappa\) the soil dielectric constant
  \item \(\theta\) grazing angle
\end{itemize}

Now we have \(r^\prime(t)\) which is the received signal as a result of the longer path length: \(R^\prime\) as well as the ground reflection coefficient: \(\rho e^{j\phi}\)
\begin{equation}
  r^\prime(t) = \rho e^{j\phi} s(t)\frac{\lambda}{4\pi R^\prime} \exp\left\{ -j 2 \pi \frac{R^\prime}{\lambda}\right\}
\end{equation}

The final signal arriving is the combination: \(r(t) + r^\prime(t)\).
Note in the worst case, where \(\theta\) is very small (large distance, small elevation), \(R \approx R^\prime\) and \(\rho e^{j\phi} \approx -1\). This equates to complete destructive interference and should be avoided.

We want to know what range and elevation would produce results which suffer least from ground reflection interference. Most critically, we want the phase of combined signal to be as close as possible (within a few percent error) of the ideal case. 
Assumptions: Tx and Rx heights are the same. The distance between RxA and RxB is \SI{1}{\meter}. This is representative of the built array. Simulate for \(h \in \left[ 0.5 , 5 \right]\) and \(R \in \left[5, 50\right]\)
Algorithm:
\begin{enumerate}
  \item For a given R
    \begin{enumerate}
      \item compute the ideal received signal for RxA and RxB with no ground reflection. Friis only.
      \item Store this ideal amplitude and phase difference.
      \item for a given h:
        \begin{enumerate}
          \item compute \(\theta\), the grazing angle and \(R^\prime\) the longer path length
          \item compute the resulting \(\rho e^{j\phi}\) from \(\theta\)
          \item compute the received signal from the reflection which is a function of the path length multiplied by the ground reflection coefficient. 
          \item add the direct and reflected.
          \item add a data point to the plot: difference between ideal and actual amplitude. difference between ideal and actual phase.
        \end{enumerate}
    \end{enumerate}
\end{enumerate}

\begin{figure}
  \centering
  \begin{subfigure}{\textwidth}
    \centering
    \includesvg[width=\textwidth, svgpath=./img/field-trials/]{ground-reflection-model}
    \caption{Model being simulated. Ideal case is the phase difference between receiving elements from \(ra\) and \(rb\) paths only. Real case is phase difference due to all four paths with ground reflection coefficient \(\rho e^{j\phi}\)}
  \end{subfigure}\\[2em]
  \begin{subfigure}{\textwidth}
    \centering
    \includegraphics[width=\textwidth, clip=true, trim=0 0 140 0]{multipath-phase-shift}
  \end{subfigure}\\[2em]
  \begin{subfigure}{\textwidth}
    \centering
    \includegraphics[width=\textwidth, clip=true, trim=0 0 140 0]{multipath-amplitude-shift}
     % left, bottom, right, top
  \end{subfigure}
  \caption{Simulation of change in antenna array response due to ground reflection multipath}
\end{figure}

Below \SI{3}{\meter} elevation, it looks like the phase becomes fairly uniform with distance after about \SI{25}{\meter}. Above \SI{1.5}{\meter} elevation the amplitude degradation is below \SI{5}{\decibel} so no need to be concerned.

\section{Non-Flat Wavefronts}
We have assumed flat wave fronts. This may not be true. Again, small sumulation to help decide on a suitable distance. Need to be far enough that the non-flatness of the wavefronts becomes not a problem.

Model: Two antennas: one directly R away from source, one d away and l to the side. l being a baseline length. Also assumed to be 1 m. 
Flat: phase diff should be 0.
Non-flat: will be some shift.
\begin{figure}
  \centering
  \begin{subfigure}{\textwidth}
    \centering
    \includesvg[width=0.7\textwidth]{curved-wavefront-model}
  \end{subfigure}\\[2em]
  \begin{subfigure}{\textwidth}
    \centering
    \includegraphics[width=0.8\textwidth]{curved-wavefront-error}
  \end{subfigure}
\end{figure}

\begin{figure}
  \centering
  \makebox[\textwidth][c]{
    \begin{subfigure}{0.55\textwidth}
      \centering
      \includegraphics[width=\textwidth]{spectrum-tx-off}
    \end{subfigure}%
    \begin{subfigure}{0.55\textwidth}
      \centering
      \includegraphics[width=\textwidth]{spectrum-tx-on}
    \end{subfigure}
  }
    \caption{Foobar}
\end{figure}

\input{./tex/95-sample-rfi}
